<script>
    // ================= C·∫§U H√åNH DATABASE (ƒê√É ƒêI·ªÄN S·∫¥N M√É C·ª¶A B·∫†N) =================
    // T√¥i ƒë√£ th√™m h√†m .trim() ƒë·ªÉ l·ª° b·∫°n c√≥ copy d∆∞ kho·∫£ng tr·∫Øng c≈©ng kh√¥ng sao
    const BIN_ID = '69840cc643b1c97be9667483'.trim(); 
    const API_KEY = '$2a$10$l1E3f1p.9DeJ0c01VdtqBuznPzCNhE.r5OEcZ1JmgPWRWoNTnyAoi'.trim(); 
    // ==============================================================================

    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    // --- 1. CH√àN GIAO DI·ªÜN ADMIN (N·∫æU CH∆ØA C√ì) ---
    if (!document.getElementById('admin-login-btn')) {
        const btn = document.createElement('button');
        btn.id = 'admin-login-btn';
        btn.innerHTML = '‚öôÔ∏è Admin Login';
        btn.onclick = openAdminLogin;
        Object.assign(btn.style, {
            position: 'fixed', bottom: '20px', right: '20px', zIndex: '9999',
            background: '#222', color: '#fff', padding: '12px 20px',
            borderRadius: '50px', cursor: 'pointer', border: '2px solid white',
            boxShadow: '0 4px 10px rgba(0,0,0,0.3)', fontWeight: 'bold'
        });
        document.body.appendChild(btn);

        const panel = document.createElement('div');
        panel.id = 'admin-panel';
        panel.innerHTML = `
            <div class="admin-container">
                <span class="close-admin" onclick="document.getElementById('admin-panel').style.display='none'">√ó</span>
                <h2 style="color:#333">Qu·∫£n tr·ªã Website</h2>
                <div class="status-bar" id="db-status">ƒêang ki·ªÉm tra k·∫øt n·ªëi...</div>
                
                <div class="admin-tab">
                    <button class="tab-btn active" onclick="switchTab('tab-posts')">B√†i Vi·∫øt</button>
                    <button class="tab-btn" onclick="switchTab('tab-team')">Nh√¢n S·ª±</button>
                    <button class="tab-btn" style="background:#dc3545; color:white" onclick="resetDatabase()">‚ôªÔ∏è Reset L·ªói</button>
                </div>

                <div id="tab-posts" class="tab-content">
                    <h3>ƒêƒÉng Tin M·ªõi</h3>
                    <div class="form-group"><input type="text" id="post-title" placeholder="Ti√™u ƒë·ªÅ b√†i vi·∫øt..."></div>
                    <div class="form-group"><textarea id="post-content" rows="5" placeholder="N·ªôi dung b√†i vi·∫øt..."></textarea></div>
                    <button class="btn-save" onclick="savePost()">L∆∞u B√†i Vi·∫øt</button>
                    <hr><h4>Danh s√°ch b√†i vi·∫øt</h4>
                    <div id="admin-post-list">ƒêang t·∫£i...</div>
                </div>

                <div id="tab-team" class="tab-content" style="display:none;">
                    <h3>Th√™m Nh√¢n S·ª±</h3>
                    <div class="form-group"><input type="text" id="team-name" placeholder="T√™n nh√¢n vi√™n..."></div>
                    <div class="form-group"><input type="text" id="team-role" placeholder="Ch·ª©c v·ª•..."></div>
                    <div class="form-group"><textarea id="team-desc" rows="3" placeholder="M√¥ t·∫£..."></textarea></div>
                    <div class="form-group"><input type="file" id="team-img" accept="image/*"></div>
                    <button class="btn-save" onclick="saveTeamMember()">L∆∞u Nh√¢n S·ª±</button>
                    <hr><h4>Danh s√°ch nh√¢n s·ª±</h4>
                    <div id="admin-team-list">ƒêang t·∫£i...</div>
                </div>
            </div>
        `;
        Object.assign(panel.style, {
            display: 'none', position: 'fixed', top: '0', left: '0', width: '100%', height: '100%',
            background: 'rgba(0,0,0,0.85)', zIndex: '10000', overflowY: 'auto', backdropFilter: 'blur(5px)'
        });
        document.body.appendChild(panel);

        const style = document.createElement('style');
        style.innerHTML = `
            .admin-container { background: #fff; max-width: 800px; margin: 50px auto; padding: 30px; border-radius: 12px; position: relative; font-family: sans-serif; }
            .close-admin { position: absolute; top: 15px; right: 20px; font-size: 30px; cursor: pointer; color: #888; }
            .admin-tab { margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom:10px; }
            .tab-btn { padding: 10px 20px; border: none; background: #f0f0f0; cursor: pointer; margin-right: 10px; border-radius: 5px; font-weight:600; }
            .tab-btn.active { background: #333; color: #fff; }
            .form-group { margin-bottom: 15px; }
            .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
            .btn-save { background: #28a745; color: white; padding: 12px 20px; border: none; cursor: pointer; width: 100%; border-radius: 6px; font-size:16px; font-weight:bold; transition: 0.3s; }
            .btn-save:hover { background: #218838; }
            .btn-delete { background: #ff4d4d; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; float:right; }
            .item-row { padding: 10px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
            .status-bar { padding: 10px; margin-bottom: 15px; border-radius: 5px; background: #e9ecef; font-size: 14px; }
        `;
        document.head.appendChild(style);
    }

    // Ch√®n khu v·ª±c tin t·ª©c c√¥ng khai
    if (!document.getElementById('dynamic-news-section')) {
        const newsHTML = `
            <section id="dynamic-news-section" style="padding: 60px 0; background: #f8f9fa;">
                <div class="w-container">
                    <h2 style="text-align:center; margin-bottom:40px; color:#333;">TIN T·ª®C HO·∫†T ƒê·ªòNG</h2>
                    <div id="public-news-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px;">
                        <div style="text-align:center; grid-column: 1/-1;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                    </div>
                </div>
            </section>
        `;
        const target = document.querySelector('.section-10');
        if(target) target.insertAdjacentHTML('afterend', newsHTML);
    }

    // --- 2. C√ÅC H√ÄM X·ª¨ L√ù API (ƒê√É N√ÇNG C·∫§P) ---

    // H√†m l·∫•y d·ªØ li·ªáu (C√≥ x·ª≠ l√Ω l·ªói 404/Empty)
    async function fetchData() {
        const statusEl = document.getElementById('db-status');
        if(statusEl) statusEl.innerHTML = "üîÑ ƒêang k·∫øt n·ªëi server...";
        
        try {
            const res = await fetch(API_URL, {
                headers: { 'X-Master-Key': API_KEY }
            });

            if (res.status === 401 || res.status === 403) {
                alert("L·ªñI: Sai M√£ API Key! Ki·ªÉm tra l·∫°i m√£ Master Key.");
                return null;
            }
            if (res.status === 404) {
                alert("L·ªñI: Sai Bin ID! Kh√¥ng t√¨m th·∫•y kho d·ªØ li·ªáu.");
                return null;
            }

            const data = await res.json();
            
            // T·ª± ƒë·ªông s·ª≠a n·∫øu d·ªØ li·ªáu tr·ªëng ho·∫∑c sai ƒë·ªãnh d·∫°ng
            if (!data.record || typeof data.record !== 'object') {
                console.log("D·ªØ li·ªáu tr·ªëng, ƒëang kh·ªüi t·∫°o l·∫°i...");
                return { posts: [], team: [] };
            }

            if(statusEl) statusEl.innerHTML = "‚úÖ K·∫øt n·ªëi ·ªïn ƒë·ªãnh";
            return data.record;

        } catch (error) {
            console.error(error);
            alert("L·ªói m·∫°ng ho·∫∑c l·ªói server: " + error.message);
            return null;
        }
    }

    // H√†m l∆∞u d·ªØ li·ªáu
    async function updateData(newData) {
        try {
            const res = await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': API_KEY
                },
                body: JSON.stringify(newData)
            });
            
            if (res.ok) return true;
            throw new Error("Server tr·∫£ v·ªÅ l·ªói: " + res.status);
        } catch (error) {
            alert("Kh√¥ng th·ªÉ l∆∞u: " + error.message);
            return false;
        }
    }

    // H√†m RESET C·ª®U H·ªò (D√πng khi b·ªã l·ªói k·∫πt d·ªØ li·ªáu)
    window.resetDatabase = async function() {
        if(!confirm("C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω X√ìA S·∫†CH d·ªØ li·ªáu c≈© v√† t·∫°o l·∫°i kho m·ªõi ƒë·ªÉ s·ª≠a l·ªói. B·∫°n c√≥ ch·∫Øc kh√¥ng?")) return;
        
        const emptyData = { posts: [], team: [] };
        const success = await updateData(emptyData);
        if(success) {
            alert("ƒê√£ reset kho d·ªØ li·ªáu th√†nh c√¥ng! Gi·ªù b·∫°n c√≥ th·ªÉ th√™m m·ªõi.");
            loadAdminData();
            renderPublicPosts([]);
            renderPublicTeam([]);
        }
    }

    // --- 3. CH·ª®C NƒÇNG ADMIN & LOGIC ---

    function openAdminLogin() {
        let tk = prompt("T√†i kho·∫£n:");
        let mk = prompt("M·∫≠t kh·∫©u:");
        if (tk === 'admin' && mk === '1') {
            document.getElementById('admin-panel').style.display = 'block';
            loadAdminData(); 
        } else {
            alert("Sai th√¥ng tin!");
        }
    }

    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- LOGIC B√ÄI VI·∫æT ---
    window.savePost = async function() {
        const title = document.getElementById('post-title').value;
        const content = document.getElementById('post-content').value;
        if(!title) return alert("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!");

        const btn = document.querySelector('.btn-save');
        btn.innerHTML = "‚è≥ ƒêang l∆∞u l√™n m√¢y..."; btn.disabled = true;

        let data = await fetchData();
        if(!data) data = { posts: [], team: [] }; // Fallback n·∫øu l·ªói
        if(!data.posts) data.posts = [];

        data.posts.unshift({
            id: Date.now(),
            title: title,
            content: content,
            date: new Date().toLocaleDateString('vi-VN')
        });

        if(await updateData(data)) {
            alert("L∆∞u th√†nh c√¥ng!");
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            renderPublicPosts(data.posts);
            loadAdminData();
        }
        btn.innerHTML = "L∆∞u B√†i Vi·∫øt"; btn.disabled = false;
    }

    window.deletePost = async function(id) {
        if(!confirm("X√≥a b√†i n√†y?")) return;
        let data = await fetchData();
        if(data && data.posts) {
            data.posts = data.posts.filter(p => p.id != id);
            await updateData(data);
            renderPublicPosts(data.posts);
            loadAdminData();
        }
    }

    // --- LOGIC NH√ÇN S·ª∞ ---
    window.saveTeamMember = async function() {
        const name = document.getElementById('team-name').value;
        const role = document.getElementById('team-role').value;
        const desc = document.getElementById('team-desc').value;
        const fileInput = document.getElementById('team-img');
        
        if(!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");

        const btn = document.querySelectorAll('.btn-save')[1];
        btn.innerHTML = "‚è≥ ƒêang x·ª≠ l√Ω ·∫£nh & l∆∞u..."; btn.disabled = true;

        const processSave = async (imgSrc) => {
            let data = await fetchData();
            if(!data) data = { posts: [], team: [] };
            if(!data.team) data.team = [];

            data.team.push({ id: Date.now(), name, role, desc, img: imgSrc });

            if(await updateData(data)) {
                alert("ƒê√£ th√™m nh√¢n s·ª±!");
                document.getElementById('team-name').value = '';
                document.getElementById('team-desc').value = '';
                renderPublicTeam(data.team);
                loadAdminData();
            }
            btn.innerHTML = "L∆∞u Nh√¢n S·ª±"; btn.disabled = false;
        };

        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { processSave(e.target.result); };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            processSave("https://via.placeholder.com/150");
        }
    }

    window.deleteMember = async function(id) {
        if(!confirm("X√≥a th√†nh vi√™n n√†y?")) return;
        let data = await fetchData();
        if(data && data.team) {
            data.team = data.team.filter(t => t.id != id);
            await updateData(data);
            renderPublicTeam(data.team);
            loadAdminData();
        }
    }

    // --- HI·ªÇN TH·ªä D·ªÆ LI·ªÜU ---
    function renderPublicPosts(posts) {
        const container = document.getElementById('public-news-list');
        if(!container) return;
        
        if(!posts || posts.length === 0) {
            container.innerHTML = `<div style="text-align:center; grid-column:1/-1; color:#888;">Ch∆∞a c√≥ tin t·ª©c n√†o.</div>`;
            return;
        }
        container.innerHTML = posts.map(p => `
            <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition:transform 0.2s;">
                <h3 style="margin-top:0; color:#d63384; font-size:18px;">${p.title}</h3>
                <small style="color:#999; font-style:italic;">üìÖ ${p.date}</small>
                <p style="margin-top:15px; line-height:1.6; color:#555;">${p.content}</p>
            </div>
        `).join('');
    }

    function renderPublicTeam(team) {
        // T√¨m v√πng grid team trong HTML g·ªëc c·ªßa Webflow
        const teamContainer = document.querySelector('.team-member-wrap .team-grid');
        if(!teamContainer) return;
        
        // X√≥a c√°c th·∫ª c≈© do JS t·∫°o ra
        document.querySelectorAll('.dynamic-team-card').forEach(c => c.remove());

        if(team && team.length > 0) {
            const html = team.map(m => `
                <div class="card dynamic-team-card">
                    <div class="author-avatar" style="border: 4px solid #f7a8b8; overflow:hidden; width:150px; height:150px; border-radius:50%; margin:0 auto 15px;">
                        <img src="${m.img}" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <h1 class="name" style="margin:10px 0;">${m.name}</h1>
                    <div class="role" style="color:#d63384; font-weight:bold;">${m.role}</div>
                    <div class="text-block-21" style="font-size:14px; margin-top:10px;">${m.desc}</div>
                </div>
            `).join('');
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            while (tempDiv.firstChild) {
                teamContainer.appendChild(tempDiv.firstChild);
            }
        }
    }

    async function loadAdminData() {
        const data = await fetchData();
        if(!data) return;

        const postList = document.getElementById('admin-post-list');
        if((data.posts || []).length === 0) postList.innerHTML = "Ch∆∞a c√≥ b√†i n√†o.";
        else postList.innerHTML = data.posts.map(p => 
            `<div class="item-row">
                <span style="font-weight:bold;">${p.title}</span> 
                <button class="btn-delete" onclick="deletePost(${p.id})">X√≥a</button>
            </div>`
        ).join('');

        const teamList = document.getElementById('admin-team-list');
        if((data.team || []).length === 0) teamList.innerHTML = "Ch∆∞a c√≥ nh√¢n s·ª± n√†o.";
        else teamList.innerHTML = data.team.map(t => 
            `<div class="item-row">
                <span><b>${t.name}</b> - ${t.role}</span> 
                <button class="btn-delete" onclick="deleteMember(${t.id})">X√≥a</button>
            </div>`
        ).join('');
    }

    // --- KH·ªûI CH·∫†Y ---
    window.addEventListener('load', async () => {
        const data = await fetchData();
        if(data) {
            renderPublicPosts(data.posts);
            renderPublicTeam(data.team);
        }
    });
</script>
